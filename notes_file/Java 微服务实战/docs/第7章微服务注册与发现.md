# [README](../README.md "回到 README")
# [目录](本书的组织结构.md "回到 目录")

## 7.1 初始Consul

**Consul是一个分布式、高可用、支持多数据中心的软件，主要用于服务注册、服务发现、key/value存储及健康检查等**。

在实际使用中，为了实现高可用，需要搭建Consul集群。在整个Consul集群中，所有的**Consul节点分为两种角色：serverAgent和clientAgent**。每个Consul集群中至少需要有一个serverAgent，官方推荐3或5台。**serverAgent会存储一些集群的状态信息，并响应集群中其他agent的相关操作**。通常在我们的应用服务器集群中的每一个节点上都会有一个clientAgent，通过该**agent将当前节点上的服务向Consul进行注册，该agent也负责该服务节点及其上的服务的健康检查**。Consul配合Spring Boot的Actuator可以非常简单地实现健康检查（只需要引入spring-boot-starter-actuator），所以可以很方便地找出健康的节点供调用方使用。**Consul的key/value存储功能也很重要，该功能可以用于动态配置、leader选举等**。Consul还提供了非常漂亮的UI，用来进行key/value、节点、服务及session（可以充当分布式锁）等的相关操作。


## 7.2 搭建Consul集群

在生产环境中，推荐Consul集群使用3台或5台serverAgent，笔者这里为了方便，只搭建了一台serverAgent，ip是10.211.55.12。此外，还搭建了两台clientAgent，ip分别是10.211.55.13和10.211.55.14。


### 7.2.1 安装Consul

第一步，在开发机下载Consul。

下载地址为：https://www.consul.io/downloads.html。笔者下载了Linux 64位的Consul。还可以直接在上边的三台centos上执行wget:https://releases.hashicorp.com/consul/0.7.2/consul_0.7.2_linux_amd64.zip-O consul.zip下载。但是，这种下载方式需要看网络速度。

第二种，将下载好的consul_0.7.2_linux_amd64.zip复制到三台centos机器上。
![](images/7.2.1.1.png)

第三步，分别进入三台centos，解压缩。
![](images/7.2.1.2.png)

之后将解压出来的二进制文件Consul移到到/usr/bin/下。
![](images/7.2.1.3.png)
Cosul安装成功后，启动各个Consul节点。


### 7.2.2 启动Consul集群

第一步，在10.211.55.12处启动serverAgent。
![](images/7.2.2.1.png)
说明：笔者将Consul以后台进程来运行，并且将相关日志写在nohup.out文件中，整条命令比较长，下面逐一介绍每个命令的选项。
* consul agent：表示该命令会启动一个consulAgent。
* -server：表示该agent是一个serverAgent，不添加这个选项的话，表示是一个clientAgent。
* -data-dir：表示相关数据存储的目录位置，在serverAgent上该目录下会存储一些集群的状态信息，而在clientAgent上主要存储在其上注册的服务信息以及这些服务的健康检查信息。
* -node：指定该agent节点的名称，该名称在集群中必须是唯一的（默认采用机器的host）。
* -bind：指定该agent的ip。
* -bootstrap-expect 1：该命令通知Consul我们现在准备加入的server节点个数，该参数是为了延迟日志复制的启动，直到指定数量的server节点成功加入后才启动。
* -client 0.0.0.0-ui：启动Consul-UI，如果不添加“-client 0.0.0.0”选项，则UI只能在当前机器上（即10.211.55.12）进行访问。
* -dc：指定该agent加入哪一个数据中心，默认是dc1。

第二步，在10.211.55.13和10.211.55.14处分别启动clientAgent并加入到集群中。
    在10.211.55.13上执行：
![](images/7.2.2.2.png)
    在10.211.55.14上执行：
![](images/7.2.2.3.png)
下面逐一介绍每个命令和选项。
* consul agent：同上；
* -data-dir：同上；
* -node：同上；
* -bind：同上；
* -join：将节点加入集群;
* -dc：同上。

这里启动的时候，我们没有指定-sever，默认以clientAgent来启动。

第三步，验证集群是否搭建成功。在三台机器的任意一台上执行：
![](images/7.2.2.4.png)
该命令用于列出集群中的所有节点，执行之后，若结果如图7-1所示，表示搭建成功。
![](images/7.2.2.5.png)


### 7.2.3 启动Consul-UI

在上一节中，在启动serverAgent时启动了Consul-Ui。下面，打开Consul-UI查看相关信息。
在浏览器中输入：http://10.211.55.12:8500,并单击其中的Nodes标签，结果如图7-2所示。
![](images/7.2.3.1.png)
**Consul-UI中有5个导航按钮，其中SERVICES导航下包含所有注册到Consul上的服务；NODES导航下包含所有Consul集群中的节点机器；KEY/VALUE导航下包含所有服务的配置信息；ACL导航下包含权限控制信息；最后一个导航按钮用于选择数据中心**。

到此，Consul集群就搭建完成了。下面，我们来编写代码实现服务注册、发现与健康检查等功能。


## 7.3 使用Consul实现服务注册与服务发现

本节将搭建的集群架构如图7-3所示。
![](images/7.3.1.png)
将创建两个服务：myserviceA和myserviceB，myserviceA将会以jar包的形式运行在10.211.55.13机器上，并通过其上的clientAgent注册到Consul集群中；myserviceB将会以jar包的形式运行在10.211.55.14机器上，同样通过其上的clientAgent注册到Consul集群中。最后，myserviceA实现发现myserviceB的功能。我们首先来开发myserviceB服务。


### 7.3.1 搭建项目框架

myserviceB服务的项目框架如图7-4所示。
![](images/7.3.1.1.png)

其中，pom.xml文件内容如下：
![](images/7.3.1.2.png)
![](images/7.3.1.3.png)
在该pom.xml中，引入了spring-boot-starter-web、Lombok、consul-client、jersey-client及spring-boot-starter-actuator5个依赖。Consul官网给出了两种Java客户端：consul-client和consul-api，可以选择其一，这里，笔者使用consul-client。为了**使用consul-client，引入了consul-client和jersey-client两个依赖；为了实现健康检查，引入了spring-boot-starter-actuator依赖，该依赖是Spring Boot可用于生产级别的监控工具，包含进行健康检查以及收集JVM的相关统计数据的metrics**。在微服务计数监控系统中，可以通过对这些统计数据进行分析告警。

项目框架搭建完成之后，可以编写程序来实现服务注册功能。


### 7.3.2 配置服务注册信息

在实现服务注册之前，首先来配置服务注册信息。在application.properties中配置信息，内容如下：
![](images/7.3.2.1.png)

service.name指定了服务名，我们通常使用服务的artifactId来命名；service.port指定服务将运行在哪一个端口；service.tag指定服务的标签，该选项主要用于区分环境，还是线上环境，通常使用dev表示开发环境prod表示线上环境；health.url是Consul进行健康检查的url，Consul会以一个指定的频率访问这个url，如果现实的是UP的值，则服务健康，否则，服务不健康；这个指定的频率就是health.interval的值。这里是10ms。这5个参数是服务向Consul注册服务的最基本的值。

配置好注册信息后，为了将这些零散的配置信息整顿起来方便后续使用，笔者编写了一个Bean来读取并封装这些参数。该Bean内容如下：
![](images/7.3.2.2.png)
这样，使用这将该Bean注入其他类中直接使用即可。其中，如果service.port的值没有配置，则默认取8080；如果service.tag的值没有配置，则默认取dev。

配置好后，接下来实现本章最核心的第一个任务：服务启动注册！


### 7.3.3 实现服务启动注册

什么是服务注册？引用第1章中的一段话，“服务注册简单形象地来讲就是将服务的ip和port注册到注册中心，这里可以简单地将注册中心理解为一个Map，其中的key是服务的唯一标识（可以是serviceID，也可以是serviceName），而value是一个包含ipAndPort结构体的集合，例如是一个List集合，该List集合中存放了指定service所在的所有服务器。”
    
下面不仅仅要**实现服务注册功能，还要实现在服务启动时自动注册到Consul**。首先定义一个Consul单例Bean。代码如下：
![](images/7.3.3.1.png)
    通常显示创建Bean的类会起名为XxxConfig。为了实现服务启动时自动注册到Consul，我们需要清楚地知道Spring Boot的启动流程。下面先看一下代码，然后再做分析。代码如下：

    ConsulRegisterListener类实现了org.springframework.context.ApplicationListener<T>，并且将泛型T指定为ContextRefreshedEvent，这样该类就会监听容器刷新事件。当Spring Boot发布该事件时，ConsulRegisterListener将会执行onApplicationEvent方法，在该方法内，调用Consul的AgentClient实现服务注册。在注册过程中，指定了服务端口、健康检查url、健康检查的时间间隔、服务名、服务ID及服务标签。其中，服务ID是在注册中心上识别服务的唯一标识，不能重复，这里将服务名作为了服务ID。
    值得注意的是，我们没有把ConsulRegisterListener这个类注册为Bean，这里提供了一种在非Bean类调用Bean的方法：先想办法获取ApplicationContext，然后再使用其getBean方法获取Bean。
    最后，将ConsulRegisterListener注册到SpringBoot的启动监听器列表中去，实现服务启动注册功能。该步骤在服务启动类中完成，代码如下：

    之前说过，要实现服务启动时自动注册到Consul，我们需要清楚地知道SpringBoot的启动流程，这是很重要的。Spring Boot的启动流程可以参考第6章Spring Boot启动源码解析部分内容。

    至此，服务启动注册功能就完成了。我们再来开发myserviceA服务，在myserviceA中实现服务发现功能。
































# [README](../README.md "回到 README")
# [目录](本书的组织结构.md "回到 目录")
