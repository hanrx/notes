# [README](../README.md "回到 README")
# [目录](本书的组织结构.md "回到 目录")

## 13.1 初识持续集成与持续部署系统

## 13.1 初识持续集成与持续部署系统

这里所说的持续集成与持续部署系统范围比较广，其功能**包括代码管理、版本管理、自动编译打包及自动部署等，当然，如果服务按照Docker镜像来部署，则还包括自动打包成镜像文件以及push到镜像仓库等步骤**。

不管是在微服务架构中，还是在传统的单体架构中，搭建一套持续集成与持续部署系统都是必要的，因为这会大大减少人力工作。如果没有持续集成与持续部署系统，我们需要自己管理代码，进行版本控制，如果一个服务的版本很多，或者代码量很大，就变得非常不好管理；如果没有持续集成与持续部署系统，我们需要手动将代码打包成jar包，手动上传到一台服务器，手动关掉之前的服务，手动启动jar包进程，如果按照Docker镜像来部署，我们可能还需要手动将服务打包成镜像，手动将镜像文件push到镜像仓库，手动将镜像文件从镜像仓库pull下来，手动将镜像运行起来。这一切都是手动的！效率极低，并且容易出错。所以，搭建一套持续集成与持续部署系统是非常有必要的！下面我们就开启本章的持续集成与持续部署之旅！


## 13.2 系统总体架构

首先来看一下本章将要搭建的持续集成与持续部署系统的总体架构，如图13-1所示。
![](images/13.2.1.png)

在整个架构中，**主要包括三大组件：GitLab、Jenkins及Docker-Registry。还有一个webhooks，这是用来轻松连接GitLab和Jenkins的纽带，它可以非常方便地实现持续集成和持续部署**。如果不使用Docker部署，则不需要安装搭建Docker-Registry。下面依次介绍各个组件。


### 13.2.1 初始GitLab

GitLab是一款**主要用于代码管理的工具**，是目前为止最受企业欢迎的代码管理工具。**GitLab包含Git仓库管理、问题追踪、活动流、代码重审及wiki等功能**。相较于GitHub，可以自己搭建服务器，这可以避免因为网络速度慢导致部署效率低下，同时，自己搭建服务器，安全性更高。**GitLab也内建了持续集成与持续部署的功能，例如，非常好用的webhook，它使得与Jenkins的集成非常简单**。


### 13.2.2 初识Jenkins

**Jenkins主要用于版本管理，进行代码的编译和部署，使用webhook插件可以实现与GitLab的集成，实现持续集成与持续部署**。Jenkins有成百上千的插件可以使用，可扩展性极强；Jenkins的安装也很简单，除了使用Docker镜像之外，还可以直接使用war包部署；并且提供了webUI，使我们可以方便地进行配置信息的管理；**Jenkins可以实现分部署部署**，这在服务数量比较多的时候很有用，可以分散压力到各个Jenkins机器上，从而减轻Jenkins的各个机器的压力，也使得服务的编译和部署的速度变快（因为不需要排队）。


### 13.2.3 初始Docker-Regsitry

**Docker-Registry是存放Docker镜像的仓库，可以类比GitLab**。Docker-Registry相较于DockerHub可以类比GitLab相较于GitHub，主要是在这里可以自己搭建镜像仓库，安全性更高，网络速度更快。如果你向DockerHub推过镜像就知道，速度通常慢的令人发指。Docker-Registry提供了便捷的API，可以让我们方便地进行镜像及版本的查询。


## 13.3 持续集成与持续部署系统工作原理

介绍完各个组件之后，来看一下整套持续集成与持续部署系统的工作原理，假设我们已经配置好了各个组件。


### 13.3.1 使用jar包部署项目的整体流程

第一步，开发人员使用Git客户端，将代码push到GitLab。
第二步，GitLab的webhook插件会通知Jenkins进行工作。
第三步，Jenkins从GitLab上拉取代码并使用Maven进行编译打包。
第四步，Jenkins将jar包发到服务器。
第五步，Jenkins调用服务器上的Shell脚本停止之前的服务，并启动jar进程。


### 13.3.2 使用Docker镜像部署项目的整体流程

第一步，开发人员使用Git客户端，将代码push到GitLab。
第二步，GitLab的webhook插件会通知Jenkins进行工作。
第三步，Jenkins从GitLab上拉取代码并使用docker-maven-plugin进行编译打包，最后将jar包打成镜像。
第四步，Jenkins将镜像push到Docker-Registry。
第五步，Jenkins调用服务器上的Shell脚本从Docker-Registry拉取镜像，然后停止之前的服务，最后启动Docker镜像。


## 13.4 搭建持续集成与持续部署系统
安装环境及软件版本
* 操作系统：centos7，ip是10.211.55.4
* Docker:1.12.3
* GitLab:8.13.1
* Jenkins:2.19.1
* Docker-Registry:2.5.0


### 13.4.1 安装启动Docker

第一步，添加yum源。
![](images/13.4.1.1.png)
添加yum源之后，可以在/etc/yum.repos.d/中找到该yum源。

第二步，安装Docker。
![](images/13.4.1.2.png)

第三步，设置Docker开机启动。
![](images/13.4.1.3.png)

第四步，启动Docker。
![](images/13.4.1.4.png)


### 13.4.2 安装配置启动GitLab

手工搭建GitLab比较费劲，这里直接使用Docker镜像进行安装。首先下载GitLab镜像，命令如下：
![](images/13.4.2.1.png)
这个过程需要一段时间，下载之后，使用如下命令查看下载的镜像信息。不熟悉Docker命令无所谓，在本章的“在学一招”部分，笔者会把常用的Docker命令列出来。
![](images/13.4.2.2.png)
之后看到如图13-2所示的信息。
![](images/13.4.2.3.png)

其中，RESPOSITORY指定了镜像来源于哪个仓库；TAG指定了镜像的版本（latest表明该版本是最新的版本）；IMAGEID指定了镜像的标识ID。

之后使用如下命令预启动GitLab：
![](images/13.4.2.4.png)
> docker run -d -h gitlab.iafoot.com -p 80:80 -v /etc/gitlab/:/etc/gitlab/ -v /var/log/gitlab/:/var/log/gitlab/ -v /var/opt/gitlab/:/var/opt/gitlab/ --name gitlab gitlab/gitlab-ce

各参数的意义如下。
* -d：该镜像以后台容器运行。
* -h gitlab.zhaojigang.com：浏览器通过该host访问GitLab。
* -p 80: 80: 浏览器通过该port访问GitLab。
* -v/etc/gitlab/ : /etc/gitlab/：将GitLab容器内部的/etc/gitlab/目录挂载到本机的/etc/gitlab/目录。操作本机的/etc/gitlab/目录相当于操作GitLab容器内部的/etc/gitlab/目录。
* —-name gitlab：启动的容器名称为GitLab。
* 最后的gitlab/gitlab-ce表示基于该镜像进行容器创建。


本次启动称为预启动，因为本次启动是为了在本机生成如下3个配置文件。
* /etc/gitlab/：配置文件所在的目录。
* /var/log/gitlab：日志所在目录。
* /var/opt/gitlab：数据所在目录。

这3个配置文件创建好之后，开始配置GitLab。修改/etx/gitlab/gitlab.rb文件，其中external_url修改如下：
![](images/13.4.2.5.png)

该配置指定了外部浏览器访问GitLab的url。这里将http端口设置为8929而不是默认的80。

之后，删除之前的GitLab容器（删除命令在本章的“再学一招”部分介绍），再使用如下命令启动GitLab：
![](images/13.4.2.6.png)
> docker run -d -h gitlab.iafoot.com -p 8929:8929 -v /etc/gitlab/:/etc/gitlab/ -v /var/log/gitlab/:/var/log/gitlab/ -v /var/opt/gitlab/:/var/opt/gitlab/ --name gitlab gitlab/gitlab-ce

启动端口是8929。启动完成后，使用如下命令查看GitLab容器是否已经被创建并运行：
![](images/13.4.2.7.png)

看到如图13-3所示的信息。
![](images/13.4.2.8.png)
这表示GitLab容器被正常创建并运行。其中容器ID为6cbd10274198，容器name为GitLab。这两个参数是我们操作容器的必要参数。

启动完成之后，可以通过浏览器中输入“http://gitlab.zhaojigang.com:8929/”来访问GitLab。在访问之前，首先需要在开发机上处理一下域名和ip的映射关系。在/etc/hosts文件中添加如下内容：
![](images/13.4.2.9.png)

之后，使用浏览器访问，在GitLab登录页注册登录后，进行GitLab主页，如图13-4所示。
![](images/13.4.2.10.png)

至此，GitLab就安装成功了！下面安装Jekins。













# [README](../README.md "回到 README")
# [目录](本书的组织结构.md "回到 目录")