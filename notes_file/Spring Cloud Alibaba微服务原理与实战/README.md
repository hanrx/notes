


## [第8章 分布式事务](docs/第8章%20分布式事务.md "第8章 分布式事务")

* 数据库事务：作为单个逻辑工作单元执行的多个数据库操作，要么同时成功，要么同时失败，它必须满足ACID特性。
    * 原子性（Atomicity）：事务必须是原子工作单元，不可继续分割，要么全部成功，要么全部失败。
    * 一致性（Consistency）：事务完成时，所有数据都必须保持一致。
    * 隔离性（Isolation）：由于并发事务所做的修改必须与任何其他并发事务所做的修改隔离。
    * 持久性（Durability）：事务执行完成之后，它对系统的影响是永久的。

* 分布式事务：是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于分布式系统的不同节点上。
* X/Open DTP：是X/Open这个组织定义的一套分布式事务的标准。提出了使用两个阶段提交（2PC，Two-Phase-Commit）来保证分布式事务的完整性。包含以下三种角色。(TM和多个RM之间的事务控制，是基于XA协议（XA Specification）来完成的。XA协议是X/Open提出的分布式事务处理规范，也是分布式事务处理的工业标准)
    * AP：Application，表示应用程序。
    * RM：Resource Manager，表示资源管理器，比如数据库。
    * TM：Transaction Manager，表示事物管理器。

* 两个阶段提交协议：
    * 第一阶段是事务的准备阶段。
    * 第二阶段是事务的提交或者回滚阶段。
    缺点：
        * 同步阻塞：RM都是事务阻塞型的，对于任何一次指令都必须要有明确的响应才能继续进行下一步，否则就会处于阻塞状态，占用的资源一直被锁定。
        * 过于保守：任何一个节点失败都会导致数据回滚。
        * 事务协调者的单点故障：如果协调者在第二阶段出现了故障，那么其他的参与者（RM）会一直处于锁定状态。
        * “脑裂”导致数据不一致问题：在第二阶段中，事务协调者向所有参与者（RM）发送commit请求后，发生局部网络异常导致只有一部分参与者（RM）接受了commit请求，这部分参与者（RM）收到请求后会执行commit操作，但是未收到commit请求的节点由于事务无法提交，导致数据出现不一致问题。

* 三阶段提交协议：（三阶段提交协议是两阶段提交协议的改进版本，它利用**超时机制**解决了同步阻塞的问题）
    * CanCommit（询问阶段）：事务协调者向参与者发送事务执行请求，询问是否可以完成指令，参与者只需要回答是或者不是即可，不需要做真正的事务操作，这个阶段会有**超时中止机制**。
    * PreCommit（准备阶段）：事务协调者会根据参与者的反馈结果决定是否继续执行，如果在询问阶段所有参与者都返回可以执行操作，则事务协调者会向所有参与者发送PreCommit请求，参与者收到请求后写redo和undo日志，执行事务操作但是不提交事务，然后返回ACK响应等待事务协调者的下一步通知。如果在询问阶段任意参与者返回不能执行操作的结果，那么事务协调者会向所有参与者发送事务中断请求。
    * DoCommit（提交或回滚阶段）：这个阶段也会存在两种结果，仍然根据上一步骤的执行结果来决定DoCommit的执行方法。如果每个参与者在PreCommit阶段都返回成功，那么事务协调者会向所有参与者发起事务提交指令。反之，如果参与者中的任一参与者返回失败，那么事务协调者就会发起中止指令来回滚事务。
    * 三阶段提交协议和两阶段提交协议相比有一些不同点：
        * 增加了一个CanCommit阶段，用于询问所有参与者是否可以执行事务操作并且响应，它的好处是，可以**尽早发现无法执行操作而中止后续的行为**。
        * 在准备阶段之后，事务协调者和参与者都引入了超时机制。
    * 两阶段提交和三阶段提交是XA协议解决分布式数据一致性问题的基本原理，但是这**两种方案为了保证数据的强一致性，降低了可用性**。

* CAP定理和BASE理论：
    * CAP定理：又叫布鲁尔定理。简单来说它是指在分布式系统中不可能同时满足一致性（C：Consistency）、可用性（A：Avaliability）、分区容错性（P：Partition Tolerance）这三个基本需求，最多同时满足两个
        * C：数据在多个副本中要保持强一致，比如前面说的分布式数据一致性问题。
        * A：系统对外提供的服务必须一直处于可用状态，在任何故障下，客户端都能在**合理的时间**内获得服务端的**非错误响应**。
        * P：**在分布式系统中遇到任何网络分区故障，系统仍然能够正常对外提供服务**。
        
        * AP：**对于AP来说，相当于放弃了强一致性，实现最终的一致，这是很多互联网公司解决分布式数据一致性问题的主要选择**。
        * CP：**放弃了高可用性，实现强一致性。前面提到的两阶段提交和三阶段提交都采用这种方案。可能导致的问题是用户完成一个操作会等待较长的时间**。
    * BASE理论：核心思想是通过牺牲数据的强一致性来获得高可用性。它有如下三个特性。
        * Basically Available（基本可用）：分布式系统在出现故障时，**允许损失一部分功能的可用性**，保证核心功能的可用。
        * Soft State（软状态）：允许系统中的数据存在中间状态，这个状态不影响系统的可用性，也就是**允许系统中不同节点的数据副本之间的同步存在延时**。
        * Eventually Consistent（最终一致性）：中间状态的数据在经过一段时间之后，会达到一个**最终的数据一致性**。
     
* 分布式事务问题的常见解决方案：
    * 基于CP的强一致性方案在**数据库性能和系统处理能力上会存在一定的瓶颈**。所以在互联网场景中更多采用**柔性事务**，所谓的**柔性事务是遵循BASE理论来实现的事务模型，它有两个特性：基本可用、柔性状态**。















































