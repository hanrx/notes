
# [README](../README.md "回到 README")

# 第5章 服务注册与发现

随着业务的发展，用户量和业务复杂度逐渐增加，系统为了支撑更大的流量需要做很多优化，比如升级服务配置提升性能。在软件方面，我们会采用微服务架构、对业务服务进行微服务化拆分、 水平扩容等来提升系统性能，以及解决业务的复杂性问题。

在微服务架构下，一个业务服务会被拆分成多个微服务，各个服务之间相互通信完成整体的功能。另外，为了避免单点故障，微服务都会采用集群方式的高可用部署，集群规模越大，性能也会越高，如图5-1所示。
![](images/5.1.png)

服务消费者要去调用多个服务提供者组成的集群。首先，服务消费者需要在本地配置文件中维护服务提供者集群的某个节点的请求地址。其次，服务提供者集群中如果某个节点下线或者宕机，服务消费者的本地配置中需要同步删除这个节点的请求地址，**防止请求发送到已宕机的节点上造成请求失败**。为了解决这类的问题，就需要引入服务注册中，它主要有以下功能：
* 服务地址的管理。
* 服务注册。
* 服务动态感知。

能够实现这类功能的组件很多，比如ZooKeeper、Eureka、Consul、Etcd、Nacos等。ZooKeeper在第4章中介绍过，在这一章中主要介绍Alibaba的Nacos。


## 5.1 什么是Alibab Nacos

Nacos致力于解决微服务中的统一配置、服务注册与发现等问题。它提供了一组简单易用的特性集，帮助开发者快速实现动态服务发现、服务配置、服务元数据及流量管理。
    
Nacos的关键特性如下。
    
    
服务发现和服务健康监测

Nacos支持基于DNS和基于RPC的服务发现。服务提供者使用原生SDK、OpenAPI或一个独立的Agent TODO注册Service后，服务消费者可以使用DNS或HTTP&API查找和发现服务。

Nacos提供对服务的实时的健康检查，阻止向不健康的主机或服务实例发送请求。**Nacos支持传输层（PING或TCP）和应用层（如HTTP、MySQL、用户自定义）的健康检查**。对于复杂的云环境和网络拓扑环境中（如VPC、边缘网络等）服务的健康检查，Nacos**提供了agent上报和服务端主动检测两种健康检查模式**。Nacos还提供了统一的健康检查仪表盘，帮助用户根据健康状态管理服务的可用性及流量。


动态配置服务

业务服务一般都会维护一个本地配置文件，然后把一些常量配置到这个文件中。这种方式在某些场景中会存在问题，比如配置需要变更时需要重新部署应用。而动态配置服务可以以中心化、外部化和动态化的方式管理所有环节的应用配置和服务配置，可以使配置管理变得更加高效和敏捷。**配置中心化管理让实现无状态服务变得更简单，让服务按需弹性扩展变得更容易**。

另外，Nacos提供了一个简洁易用的UI（控制台样例Demo）帮助用户管理所有服务和应用配置。Nacos还提供了**包括配置版本跟踪、金丝雀发布、一键回滚配置及客户端配置更新状态跟踪**在内的一系列开箱即用的配置管理特性，帮助用户更安全地在生产环境中管理配置变更，降低配置变更带来的风险。


动态DNS服务

动态DNS服务支持权重路由，让**开发者更容易地实现中间层负载均衡、更灵活的路由策略、流量控制，以及数据中心内网的简单DNS解析服务**。

服务及其元数据管理

Nacos可以使开发者从微服务平台建设的视角管理数据中心的所有服务及元数据，**包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的SLA及最重要的metrics统计数据**。
    
本书主要围绕Nacos中注册中心的特性及动态配置服务的特性进行展开讲解。


## 5.2 Nacos的基本使用

下面我们来初步了解Nacos的基本使用。

### 5.2.1 Nacos的安装

Nacos支持三种部署模式，分别是单机、集群和多集群。需要注意的是，Nacos依赖Java环境，并且要求使用JDK 1.8以上版本。

Nacos的安装方式有两种，一种是源码安装，另一种直接是使用以及编译好的安装包。由于后续需要分析Nacos源码，所以选择第一种安装方式。
* 在https://github.com/alibaba/nacos/releases上下载当前Nacos的最新版本（1.1.4）。
* 解压进入根目录，执行mvn-Prelease-nacos clean install-U构建，构建之后会创建一个distribution目录。
* 执行cd distribution/target/nacos-server-$version/nacos/bin。
* 执行sh startup.sh-m standalone，启动服务。
* 服务启动之后，可以通过http://127.0.0.1:8848/nacos访问Nacos的控制台。**控制台主要用于增强对服务列表、健康状态管理、服务治理、分布式配置管理等方面的管控能力**，可以进一步帮助开发者降低管理微服务应用架构的成本。


### 5.5.2 Nacos服务注册发现相关API说明

Nacos提供了SDK及Open API的方式来完成服务注册与发现等操作，由于**服务端只提供了REST接口，所以SDK本质上是对HTTP请求的封装**。下面简单列一下服务注册相关的核心接口。
    
注册实例
将服务地址信息注册到Nacos Server：
![](images/5.5.2.1.png)
参数说明如下。
* serviceName：服务名称。
* ip：服务实例IP。
* port：服务实例Port。
* clusterName：集群名称，表示该服务实例属于哪个集群。
* instance：实例属性，实际上就是把上面这些参数封装成一个对象。

调用方式：
![](images/5.5.2.2.png)

获取全部实例
根据服务名称从Nacos Server上获取所有服务实例：
![](images/5.5.2.3.png)
参数说明如下。
* serviceName：服务名称。
* cluster：集群列表，可以传递多个值。

调用方式：
![](images/5.5.2.4.png)

监听服务
监听服务是指监听指定服务下的实例变化。在前面的分析中我们知道，客户端从Nacos Service上获取的实例必须是健康的，否则会造成客户端请求失败。监听服务机制可以让客户端及时感知服务提供者实例的变化。
![](images/5.5.2.5.png)
参数说明如下。
* EventListener：当服务提供者实例发生上、下线时，会触发一个事件回调。

需要注意的是，监听服务的Open API也访问/nacos/v1/ns/instance/list，具体的原理会在源码分析中讲解。
    
服务监听有两种方式：
* 第一种是客户端调用/nacos/v1/ns/instance/list定时轮询。
* 第二种是基于DatagramSocket的UDP协议，实现服务端的主动推送。


### 5.2.3 Nocas集成Spring Boot实现服务注册与发现

本节通过Spring Boot集成Nacos实现一个简单的服务注册与发现功能。
* 创建一个Spring Boot工程spring-boot-nacos-discovery。
* 添加Maven依赖。
![](images/5.2.3.1.png)

* 创建DiscoveryController类，通过@NacosInjected注入Nacos的NamingService，并提供discovery方法，可以根据服务名称获得注册到Nacos上的服务地址。
![](images/5.2.3.2.png)

* 在application.properties中添加Nacos服务地址的配置。
![](images/5.2.3.3.png)

* 启动SpringBootNacosDiscoveryApplication，调用curl http://127.0.0.1:8080/discovery?serviceName=example去Nacos服务器上查询服务名称example所对应的地址信息，此时由于Nacos Service并没有example的服务实例，返回一个空的JSON数组[]。
* 接着，通过Nacos提供的Open API，向Nacos Servier注册一个名字为example的服务。
![](images/5.2.3.4.png)
> curl -X PUT  'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=example&ip=127.0.0.1&port=8080'
* 再次访问curl  http://127.0.0.1:8080/discovery?serviceName=example，将返回以下信息。
![](images/5.2.3.5.png)

通过Spring Boot集成Nacos实现服务注册与发现的案例，相信大家对Nacos已经有了一个初步的认识。


## 5.3 Nacos的高可用部署

在分布式架构中，任何中间件或者应用都不允许单点存在，所以开源组件一般都会自己支持高可用集群解决方案。如图5-2所示，Nacos提供了类似于ZooKeeper的集群架构，包括一个Leader节点和多个Follower节点。和ZooKeeper不同的是**，它的数据一致性算法采用的是Raft**，通用采用了该算法的中间件有Redis Sentinel的Leader选举、Etcd等。
![](images/5.3.1.png)


### 5.3.1 安装环境要求

请确保在环境中安装使用：
* 64 bit OS Linux/Unix/Mac，推荐使用Linux系统。
* 64 bit JDK 1.8及以上，下载并配置。
* Maven 3.2.x及以上，下载并配置。
* 3个或3个以上的Nacos节点才能构成集群。
* MySQL数据库。


### 5.3.2 安装包及环境准备
准备3台服务器，笔者采用的是Centos7.x系统。
* 下载安装包，分别进行解压：tar -zxvf nacos-service-1.1.4.tar.gz或者unzip nacos-server-1.1.4.zip。
* 解压后得到5个文件夹：bin（服务启动/停止脚本）、conf（配置文件）、logs（日志）、data（derby数据库存储）、target（编译打包后的文件）。


### 5.3.3 集群配置

在conf目录下包含以下文件。
	* application.properties：Spring Boot项目默认的配置文件。
	* cluster.conf.example：集群配置样例文件。
	* nacos-mysql.sql：MySQL数据库脚本。Nacos支持Derby和MySQL两种持久化机制，默认采用Derby数据库。如果采用MySQL，需要运行该脚本创建数据库和表。
	* nacos-logback.xml：Nacos日志配置文件。

配置Nacos集群需要用到cluster.conf文件，我们可以直接重命名提供的example文件，修改该配置信息如下：    
![](images/5.3.3.1.png)
这3台机器中的cluster.conf配置保持一致。由于这3台机器之间需要彼此通信，所以在部署的时候需要防火墙对外开放8848端口。


### 5.3.4 配置MySQL数据库










# [README](../README.md "回到 README")