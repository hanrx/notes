# 4.3.1 背景说明* 生产中的问题    * 生产环境发生了内存溢出该如何处理？    * 生产环境应用给服务器分配多少内存合适？    * 如何对垃圾回收器的性能进行调优？    * 生产环境CPU负载飙高该如何处理？    * 生产环境应用给应用分配多少线程合适？    * 不加log，如何确定请求是否执行了某一行代码？    * 不加log,如何实时查看某个方法的入参与返回值？* 为什么要调优？    * 防止出现OOM    * 解决OOM    * 减少Full GC出现的频率    * 不同阶段的考虑：    * 上线前    * 项目运行阶段    * 线上出现OOM    * 监控的依据    * 运行日志    * 异常堆栈    * GC日志    * 线程快照    * 堆转储快照    * 调优的大方向    * 合理编写代码    * 充分合理的使用硬件资源    * 合理的进行JVM调优## 4.3.1.1 性能优化步骤* 1.发现问题：性能监控。    * GC频繁    * cpu load过高    * OOM    * 内存泄漏    * 死锁    * 程序响应时间较长* 2.排查问题：性能分析。    * 打印GC日志，通过GCviewer或者http://gceasy.io来分析日志信息    * 灵活运用命令行工具，jstack、jmap、jinfo等    * dump出堆文件，使用内存分析工具分析文件    * 使用阿里Arthas、或jconsole、JVisualVM来实时查看JVM状态    * jstack查看堆栈信息* 3.解决问题：性能调优。    * 适当增加内存，根据业务背景选择垃圾回收器    * 优化代码，控制内存使用    * 增加机器，分散节点压力    * 合理设置线程池线程数量    * 使用中间件提高程序效率，比如缓存，消息队列等    * 其他...  ## 4.3.1.2 性能评价/测试指标* 1.停顿时间（或响应时间）：执行垃圾收集时，程序的工作线程被暂停的时间。* 2.吞吐量：单位时间的工作（请求）量。  * 运行用户代码时间，占总运行时间的比例。-XX:GCTimeRatio=n* 3.并发数：同一时刻，对服务器有实际交互的请求数。* 4.内存占用：java堆区所占的内存大小。* 5.相互间的关系：# 4.3.2 JVM命令行监控工具![img_92.png](img_92.png)自带命令行工具源码：https://hg.openjdk.java.net/jdk/jdk11/file/1ddf9a99e4ad/src/jdk.jcmd/share/classes/sun/tools* 01-概述  * 02-jpa：查看正在运行的Java进程  * 03-jstat：查看JVM统计信息  * 04-jinfo：实时查看和修改JVM配置参数  * 05-jmap：导出内存映射文件&内存使用情况  * 06-jhat:JDK自带堆分析工具  * 07-jstack：打印JVM中线程快照  * 08-jcmd：多功能命令行  * 09-jstatd：远程主机信息收集* 02-jpa：查看正在运行的Java进程> jps（Java Process Status）> > 显式指定系统内所有HotSpot虚拟机进程（查看虚拟机进程信息），可用于查询正在运行的虚拟机进程。> > 说明：对于本地虚拟机进程来说，进程的本地虚拟机ID与操作系统的进程ID是一致的，是唯一的。 * 03-jstat：查看JVM统计信息>   * 04-jinfo：实时查看和修改JVM配置参数* 05-jmap：导出内存映射文件&内存使用情况* 06-jhat:JDK自带堆分析工具* 07-jstack：打印JVM中线程快照* 08-jcmd：多功能命令行* 09-jstatd：远程主机信息收集https://www.bilibili.com/video/BV1PJ411n7xZ?p=305&spm_id_from=pageDriver